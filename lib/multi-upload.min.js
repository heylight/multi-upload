!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("spark-md5"),require("axios")):"function"==typeof define&&define.amd?define(["spark-md5","axios"],t):(e=e||self).MultiUpload=t(e.SparkMD5,e.axios)}(this,function(h,s){"use strict";h=h&&Object.prototype.hasOwnProperty.call(h,"default")?h.default:h,s=s&&Object.prototype.hasOwnProperty.call(s,"default")?s.default:s;return class{constructor(e){this.el=document.querySelector("input[type=file]"),this.checkURL="",this.uploadURL="",this.mergeURL="",this.md5="",this.chunks=[],this.maxRequest=6,this.filename="",Object.assign(this,e),"string"==typeof this.el&&(this.el=document.querySelector(this.el)),this.updateFn=()=>{},this.el.addEventListener("change",this.changeFile.bind(this))}onupdate(e){this.updateFn=e.bind(this)}onchange(e){this.changeFn=e.bind(this)}onprogress(e){this.progressFn=e.bind(this)}changeFile(e){if(1===e.target.files.length){const t=e.target.files[0];this.changeFn(t)?(this.chunks=[],this.calcMD5(t).then(e=>{this.md5=e,this.getServerFileInfo(t,e)})):console.log("abort")}else this.emit("error","只能上传一个文件"),this.el.file.value=""}calcMD5(n){return new Promise((t,e)=>{const i=new h.ArrayBuffer,s=new FileReader;s.onload=e=>{i.append(e.target.result),t(i.end())},s.onerror=()=>{e(new Error("md5 error"))},s.readAsArrayBuffer(Blob.prototype.slice.call(n,0,n.size))})}getServerFileInfo(o,e){s.post(this.checkURL+"?identifier="+e).then(e=>{if(1===e.data?.code){const{uploadedChunk:n,chunkSize:h}=e.data.data;var t=Math.ceil(o.size/h);this.chunkSize=h;for(let e=0;e<t;e++){var i=e+1===t?o.size%h:h,s=Blob.prototype.slice.call(o,e*h,e*h+i);this.chunks.push({index:e,isDone:n.includes(e)?2:0,chunk:s,size:i})}this.upload()}})}upload(){const t=this.chunks.find(e=>0===e.isDone);var e=this.chunks.filter(e=>1===e.isDone),i=this.chunks.filter(e=>2===e.isDone);if(!(e.length>=this.maxRequest)){if(this.progressFn(i.length,this.chunks.length),t&&i.length<this.chunks.length){t.isDone=1,this.upload();let e=new FormData;e.append("chunk",t.index),e.append("identifier",this.md5),e.append("file",t.chunk),s.post(this.uploadURL,e,{headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(e=>{1===e.data?.code?t.isDone=e.data.data.uploaded?2:0:t.isDone=0,this.upload()}).catch(()=>{t.isDone=0,this.upload()})}i.length===this.chunks.length&&this.mergeFile()}}mergeFile(){s.post(this.mergeURL,{identifier:this.md5,fileName:this.filename}).then(e=>{1===e.data?.code&&console.log("done")})}}});
